# He-3検出器配置最適化プロジェクト仕様書

## 1. プロジェクト概要

### 1.1 背景
NBoxは中性子検出シミュレータであり、HDPE（高密度ポリエチレン）モデレータ内にHe-3検出器を配置して中性子を検出する。検出効率は検出器の配置に大きく依存するが、最適な配置を決定する体系的な手法が確立されていない。

### 1.2 目的
複数のアプローチを用いてHe-3検出器の最適配置を探索し、各手法の特性を比較検証する。

### 1.3 期待される成果
- 物理ベースとAIベースの最適化手法の比較
- 各エネルギー領域における最適配置の知見
- 手法選択のガイドライン

---

## 2. 対象システム

### 2.1 ジオメトリ

#### モデレータ
- **材質**: HDPE（高密度ポリエチレン）
- **形状**: 直方体
- **寸法**: 460 × 460 × 1100 mm (X × Y × Z)
- **ビームパイプ**: 中心を貫通する真空円筒（直径44 mm）

#### He-3検出器
2種類の検出器を使用する：

| 検出器タイプ | 直径 | 長さ | 壁厚 | ガス圧力 | 備考 |
|-------------|------|------|------|----------|------|
| He3_ELIGANT | 25.4 mm | 500 mm | 0.8 mm | 1216 kPa (≈12 atm) | 標準タイプ |
| He3_ELIGANT_Long | 25.4 mm | 1000 mm | 0.8 mm | **不明** | 長尺タイプ |

> **注記**: He3_ELIGANT_Longのガス圧力は現時点で不明である。本プロジェクトでは以下の候補値でシミュレーションを実施し、圧力依存性を評価する：
> - 608 kPa (6 atm) - 低圧候補
> - 1216 kPa (12 atm) - 標準タイプと同等と仮定
> - 2432 kPa (24 atm) - 高圧候補

#### 現在の検出器配置（4rings.json基準）
| リング | 検出器タイプ | 本数 | 半径 |
|--------|-------------|------|------|
| A | He3_ELIGANT | 8 | 59 mm |
| B | He3_ELIGANT | 16 | 110 mm |
| C | He3_ELIGANT | 20 | 155 mm |
| D | He3_ELIGANT | 28 | 195 mm |
| **合計** | | **72本** | |

### 2.2 パラメータ空間
| パラメータ | 範囲 | 単位 | 備考 |
|-----------|------|------|------|
| リング半径 (R) | 22 - 200 | mm | ビームパイプ(22mm)外側から箱端まで |
| 検出器数/リング | 4 - 28 | 本 | 物理的干渉を考慮 |
| リング数 | 1 - 5 | 層 | |
| 中性子エネルギー | 1e-3 - 10 | MeV | 対数スケール |

### 2.3 制約条件
- 検出器同士が物理的に重ならない（最小間隔: 直径 + マージン）
- 検出器がビームパイプ（R=22mm）に干渉しない
- 検出器がモデレータ壁（X,Y: ±230mm）に干渉しない
- 検出器長さがモデレータZ方向（1100mm）に収まる
  - He3_ELIGANT (500mm): 常に収まる
  - He3_ELIGANT_Long (1000mm): 50mmのマージンあり

### 2.4 評価指標
- **主指標**: 検出効率（検出数/入射中性子数）
- **副指標**: 計算コスト、収束速度

---

## 3. 最適化手法

### 3.1 Phase 1: フラックスマップ（物理ベース）

#### 概要
モデレータ内の熱中性子フラックス分布を直接計測し、最適配置を導出する。

#### 手法
1. モデレータを細かいボクセル（例: 5mm格子）に分割
2. 各ボクセルでの熱中性子フラックスを記録
3. フラックス分布を可視化
4. 高フラックス領域に基づいて配置を決定

#### 入射中性子エネルギー
中性子のエネルギーによって熱中性子化する位置が異なるため、複数のエネルギーでフラックスマップを作成する：

| エネルギー | 備考 |
|-----------|------|
| 1 keV | 低エネルギー領域 |
| 10 keV | |
| 100 keV | |
| 1 MeV | 中エネルギー領域 |
| 5 MeV | |
| 10 MeV | 高エネルギー領域 |

> **注記**: 低エネルギー中性子は浅い位置で熱化し、高エネルギー中性子はより深い位置まで侵入してから熱化する。このため、最適な検出器配置はエネルギー依存性を持つ。

#### 出力
- 3次元フラックスマップ（ROOT TH3D または CSV）- **エネルギーごと**
- 2次元断面図（XY, XZ, YZ平面）- **エネルギーごと**
- 半径方向フラックスプロファイル - **エネルギーごと**
- エネルギー間の比較プロット

#### 利点
- 物理的に明確な「正解」を提供
- 一度の計算で全空間の情報を取得

#### 欠点
- 計算コストが高い（高統計が必要）
- 離散化による誤差


### 3.2 Phase 2: ベイズ最適化（AI）

#### 概要
Gaussian Processを用いて効率関数をモデル化し、少ない試行で最適解を探索する。

#### 手法
1. 初期サンプル点でシミュレーション実行
2. Gaussian Processで効率関数を推定
3. Acquisition function（EI, UCB等）で次の探索点を決定
4. 収束まで繰り返し

#### ツール候補
- Python: `scikit-optimize`, `GPyOpt`, `Optuna`
- 言語間連携: Python → JSON設定 → NBox実行 → 結果解析

#### 出力
- 最適パラメータと効率
- 収束履歴
- 効率関数の推定分布

#### 利点
- 少ない試行で収束
- 不確実性の定量化が可能

#### 欠点
- 局所解に陥る可能性
- 高次元では効率低下


### 3.3 Phase 3: 遺伝的アルゴリズム（AI）

#### 概要
配置パラメータを「遺伝子」として進化的に最適化する。

#### 手法
1. 初期集団をランダム生成
2. 各個体の適応度（効率）を評価
3. 選択・交叉・突然変異で次世代を生成
4. 収束まで繰り返し

#### ツール候補
- Python: `DEAP`, `PyGAD`

#### 出力
- 最適パラメータと効率
- 世代ごとの進化履歴
- パレートフロント（多目的の場合）

#### 利点
- 広い探索空間をカバー
- 局所解を回避しやすい
- 複数の良解を同時に発見

#### 欠点
- 収束に多くの評価が必要
- パラメータ調整が必要（集団サイズ、突然変異率等）


### 3.4 Phase 4: 比較・検証

#### 比較項目
| 項目 | フラックスマップ | ベイズ最適化 | 遺伝的アルゴリズム |
|------|-----------------|--------------|-------------------|
| 最適効率 | 基準値 | vs 基準 | vs 基準 |
| 計算コスト | 評価回数 | 評価回数 | 評価回数 |
| 収束速度 | N/A | 反復回数 | 世代数 |
| 解の多様性 | 分布全体 | 単一解 | 複数解 |

---

## 4. 実装要件

### 4.1 NBox側の拡張
- [ ] モノエナジー中性子源の簡易設定機能
- [ ] フラックス記録用SensitiveDetector
- [ ] ボクセルジオメトリ生成
- [ ] バッチ実行モード（設定ファイル駆動）

### 4.2 最適化フレームワーク
- [ ] Python最適化スクリプト
- [ ] NBoxとのインターフェース（JSON設定、結果解析）
- [ ] 結果データベース（SQLite or CSV）

### 4.3 可視化
- [ ] フラックスマップ可視化（ROOT or matplotlib）
- [ ] 収束履歴プロット
- [ ] 比較ダッシュボード

### 4.4 シミュレーション設定

#### イベント数
| 用途 | イベント数 | 相対誤差（ε=60%想定） |
|------|-----------|----------------------|
| AI最適化の各試行 | 100,000 | ~0.4% |
| フラックスマップ | 1,000,000 | ~0.13% |
| 最終評価・検証 | 1,000,000 | ~0.13% |

> **注記**: 1Mイベントでも数分で完了するため、十分な統計精度を確保する。

#### 結果ファイル管理
スレッドごとに生成されるROOTファイルを `hadd` でマージし、エネルギーごとに命名する：
- `1keV.root`
- `10keV.root`
- `100keV.root`
- `1MeV.root`
- `5MeV.root`
- `10MeV.root`

---

## 5. ディレクトリ構成

```
docs/optimization/
├── 01_specification.md          # 本仕様書
├── 02_implementation_plan.md    # 詳細実装計画書
│
├── phase1_fluxmap/              # Phase 1: フラックスマップ
│   ├── README.md                # 手法の説明
│   ├── scripts/                 # 解析・可視化スクリプト
│   │   ├── analyze_flux.py
│   │   └── plot_fluxmap.py
│   ├── configs/                 # シミュレーション設定
│   │   └── fluxmap_geometry.json
│   ├── simulations/             # シミュレーション結果
│   │   ├── 1keV.root
│   │   ├── 10keV.root
│   │   ├── 100keV.root
│   │   ├── 1MeV.root
│   │   ├── 5MeV.root
│   │   └── 10MeV.root
│   └── results/                 # 解析結果・プロット
│       ├── fluxmap_1keV.png
│       └── ...
│
├── phase2_bayesian/             # Phase 2: ベイズ最適化
│   ├── README.md
│   ├── scripts/
│   │   ├── bayesian_optimizer.py
│   │   └── run_nbox.py
│   ├── configs/
│   ├── simulations/
│   └── results/
│
├── phase3_genetic/              # Phase 3: 遺伝的アルゴリズム
│   ├── README.md
│   ├── scripts/
│   │   ├── genetic_optimizer.py
│   │   └── run_nbox.py
│   ├── configs/
│   ├── simulations/
│   └── results/
│
└── phase4_comparison/           # Phase 4: 比較・検証
    ├── README.md
    ├── scripts/
    │   └── compare_methods.py
    └── results/
        └── comparison_report.md
```

---

## 6. スケジュール（目安）

| Phase | 内容 | 依存関係 |
|-------|------|----------|
| 1 | フラックスマップ実装・実行 | - |
| 2 | ベイズ最適化実装・実行 | Phase 1（検証用） |
| 3 | 遺伝的アルゴリズム実装・実行 | Phase 1（検証用） |
| 4 | 比較・考察・文書化 | Phase 1, 2, 3 |

---

## 7. 成功基準

1. フラックスマップから物理的に妥当な最適配置が得られる
2. AI手法がフラックスマップの結果を±5%以内で再現
3. 各手法の計算コスト比較が定量的に示される
4. 結果が再現可能（設定・乱数シード管理）

---

## 8. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 計算時間過大 | スケジュール遅延 | 粗い探索から開始、並列化 |
| AI手法が収束しない | 比較不能 | ハイパーパラメータ調整、手法変更 |
| 結果の再現性問題 | 検証不能 | 乱数シード固定、設定管理 |
| 長尺検出器の圧力不明 | 効率評価の不確実性 | 複数圧力値での感度解析 |

---

## 9. 参考文献

- ELIGANT-TN論文（ビームパイプ仕様）
- Geant4 Documentation（フラックス計測）
- scikit-optimize documentation
- DEAP documentation

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-21 | 0.1 | 初版作成 |
| 2026-01-21 | 0.2 | 検出器仕様の詳細化、モデレータサイズ更新(Z:640→1100mm)、長尺検出器の圧力不明に関する注記追加 |
| 2026-01-21 | 0.3 | ディレクトリ構成追加、シミュレーション結果管理方針追加、モノエナジー中性子源の要件追加 |
| 2026-01-21 | 0.4 | イベント数の指針追加 |
